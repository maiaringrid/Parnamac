# =======================
# GLOBAL
# =======================
client_max_body_size 200M;

# =======================
# UPSTREAMS
# =======================
# ISP
upstream webmail {
    server webmail:80;
}

upstream portal {
    server portal:80;
}

# Cliente 1
upstream proxy_cliente1 {
    server proxy1:80;
}

# Cliente 2
upstream proxy2 {
    server proxy2:80;
}

# Cliente 3
upstream proxy3 {
    server proxy3:80;
}

# =======================
# HTTP → HTTPS (Exceto Backend)
# =======================
server {
    listen 80;
    server_name webmail.parnamac.com.br portal.parnamac.com.br
                portal.netflix.com.br hotsite.netflix.com.br sign.netflix.com.br
                portal.macau.com.br cms.macau.com.br adminer.macau.com.br
                portal.memorial.com.br cms.memorial.com.br adminer.memorial.com.br;
    return 301 https://$host$request_uri;
}

# =======================
# BACKEND - MANTÉM HTTP
# =======================
server {
    listen 80;
    server_name backend.netflix.com.br;

    location / {
        proxy_pass http://proxy_cliente1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# =======================
# ISP
# =======================
server {
    listen 443 ssl;
    server_name webmail.parnamac.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://webmail;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

server {
    listen 443 ssl;
    server_name portal.parnamac.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://portal;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# =======================
# CLIENTE 1 (Netflix)
# =======================
# Portal
server {
    listen 443 ssl;
    server_name portal.netflix.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy_cliente1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# Hotsite
server {
    listen 443 ssl;
    server_name hotsite.netflix.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy_cliente1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}

# Sign (Frontend + API)
server {
    listen 443 ssl;
    server_name sign.netflix.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy_cliente1;
        proxy_set_header Host $host;
    }

    location /api {
        proxy_pass http://proxy_cliente1;
        proxy_set_header Host $host;
    }
}

# =======================
# CLIENTE 2 (Macau)
# =======================
# Portal
server {
    listen 443 ssl;
    server_name portal.macau.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy2;
        proxy_set_header Host $host;
    }
}

# CMS
server {
    listen 443 ssl;
    server_name cms.macau.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy2;
        proxy_set_header Host $host;
    }
}

# Adminer
server {
    listen 443 ssl;
    server_name adminer.macau.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy2;
        proxy_set_header Host $host;
    }
}

# =======================
# CLIENTE 3 (Memorial)
# =======================
# Portal
server {
    listen 443 ssl;
    server_name portal.memorial.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy3;
        proxy_set_header Host $host;
    }
}

# CMS
server {
    listen 443 ssl;
    server_name cms.memorial.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy3;
        proxy_set_header Host $host;
    }
}

# Adminer
server {
    listen 443 ssl;
    server_name adminer.memorial.com.br;

    ssl_certificate     /etc/nginx/certs/nginx-selfsigned.crt;
    ssl_certificate_key /etc/nginx/certs/nginx-selfsigned.key;
    client_max_body_size 200M;

    location / {
        proxy_pass http://proxy3;
        proxy_set_header Host $host;
    }
}

# =======================
# Cabeçalhos de Segurança
# =======================
add_header X-Frame-Options "SAMEORIGIN";
add_header X-Content-Type-Options "nosniff";
add_header X-XSS-Protection "1; mode=block";
